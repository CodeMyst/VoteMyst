@inject DatabaseHelperProvider DatabaseHelpers
@inject UserProfileBuilder ProfileBuilder

@using VoteMyst.Database

@model Dictionary<EventState, Event[]>
@{
    ViewData["Title"] = "Browse";
    Layout = "_Layout";

    UserAccount currentUser = ProfileBuilder.FromPrincipal(User);
    Event[] observableHiddenEvents = Model[EventState.Hidden].Where(e => DatabaseHelpers.Events.CanViewHiddenEvent(currentUser, e)).ToArray();
}

@if (currentUser.Permissions.HasFlag(GlobalPermissions.CreateEvents))
{
    <div>
        <a class="button" asp-controller="events" asp-action="new">Create an event</a>
    </div>
}

<div class="events">
    @if ((Model[EventState.Ongoing].Count() + Model[EventState.Voting].Count()) > 0)
    {
        <div class="events-active">
            <h1>Active events</h1>
            <div class="event-container">
                @foreach (Event e in Model[EventState.Ongoing].Concat(Model[EventState.Voting]))
                {
                    <partial name="_EventInfo" for="@e" />
                }
            </div>
        </div>
    }
    @if (Model[EventState.Revealed].Count() > 0 || observableHiddenEvents.Length > 0)
    {
        <div class="events-planned">
            <h1>Planned events</h1>
            <div class="event-container">
                @foreach (Event e in observableHiddenEvents)
                {
                    <partial name="_EventInfo" for="@e" />
                }
                @foreach (Event e in Model[EventState.Revealed])
                {
                    <partial name="_EventInfo" for="@e" />
                }
            </div>
        </div>
    }
    @if (Model[EventState.Closed].Count() > 0)
    {
        <div class="events-finished">
            <h1>Finished events</h1>
            <div class="event-container">
                @foreach (Event e in Model[EventState.Closed])
                {
                    <partial name="_EventInfo" for="@e" />
                }
            </div>
        </div>
    }
</div>